"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const createLogger = require('ilp-logger');
const eventemitter2_1 = require("eventemitter2");
const debug = createLogger('ilp-ws-reconnect');
const DEFAULT_RECONNECT_INTERVAL = 5000;
class WebSocketReconnector extends eventemitter2_1.EventEmitter2 {
    constructor(options) {
        super();
        this._interval = options.interval || DEFAULT_RECONNECT_INTERVAL;
        this.WebSocket = options.WebSocket;
    }
    open(url) {
        this._url = url;
        this._instance = new (this.WebSocket)(this._url);
        this._instance.on('open', () => void this.emit('open'));
        this._instance.on('close', (code, reason) => this._reconnect(code));
        this._instance.on('error', (err) => this._reconnect(err));
        this._instance.on('message', (data) => void this.emit('message', data));
        return new Promise((resolve) => void this.once('open', resolve));
    }
    send(data, cb) {
        return this._instance.send(data, cb);
    }
    close() {
        this._instance.removeAllListeners();
        this.emit('close');
        this._instance.close();
    }
    _reconnect(codeOrError) {
        debug.debug(`websocket disconnected with ${codeOrError}; reconnect in ${this._interval}`);
        this._connected = false;
        this._instance.removeAllListeners();
        setTimeout(() => {
            void this.open(this._url);
        }, this._interval);
        this.emit('close');
    }
}
exports.WebSocketReconnector = WebSocketReconnector;
//# sourceMappingURL=ws-reconnect.js.map